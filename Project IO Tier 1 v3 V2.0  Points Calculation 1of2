## TABLES USED IN THIS SCRIPT ## 

DEFINE MACRO opportunity_pipeline youtube_pd_project_io.opportunities_tier1_v3_live;
DEFINE MACRO country_bands_pipeline youtube_pd_project_io.country_bands_tier1_table_v3;
DEFINE MACRO implementation_pipeline youtube_pd_project_io.implementation_tier1_v3_table.all;
DEFINE MACRO pro_pipeline youtube_pd_project_io.pro_tier1_v3_table;
## MAPPING Table ##
DEFINE MACRO map_table youtube_pd_project_io.offering_tier1_v3_map;  
DEFINE MACRO map_table_source youtube_pd_project_io.offering_mapping_table_v3;
## TABLES GENERATED BY THIS SCRIPT ##
DEFINE MACRO opty_table youtube_pd_project_io.io_opty_tier1_v3_base;
DEFINE MACRO country_bands_table youtube_pd_project_io.country_tier1_v3_metrics;
DEFINE MACRO implementation_table youtube_pd_project_io.io_implementation_tier1_v3;

-- select * from youtube_pd_project_io.io_opty_tier1_v3_base;
-- select * from youtube_pd_project_io.offering_tier1_v3_map;
-- select * from youtube_pd_project_io.country_tier1_v3_metrics;
-- select * from youtube_pd_project_io.io_implementation_tier1_v3;

-- SET queryrequest.accounting_group 'youtube-pd-placer-write';

################### CREATING TEMP TABLE #####################################################################################################################################
##############################################################################

create OR replace table $map_table AS  
select 
OFFERING_ID,
OFFERING_TYPE,
IMPLEMENTATION_REFERENCE,
OFFERING_DESCRIPTION,
KPI,
regexp_replace(kpi,"_avg_daily_change","") as KPI_REFERENCE,
KPI as COUNTRY_METRICS_REFERENCE,
CASE WHEN UPPER(implementation_reference) LIKE '%FLAG%' THEN TRUE ELSE FALSE END as BOOLEAN_FIELD,
CASE WHEN UPPER(implementation_reference) LIKE '%PCT%' THEN 'PERCENT' ELSE 'NUMBER' END as METRIC_TYPE 
FROM $map_table_source; 


##############################################################################
CREATE OR REPLACE table $opty_table AS ## ADDED tier1 
select DISTINCT
pitch_date as pitch_date,
base.opp_id,
base.pro_id,
base.offering_id,
base.offering_type,
base.offering_description,
base.kpi,
pro.spm_ldap,
map.KPI as METRICS_MAP,
map.KPI_REFERENCE as KPI_REFERENCE,
pro.pro_country_code as country_code,
FROM $opportunity_pipeline base  ## Added tier1
LEFT JOIN $map_table map on base.kpi = map.kpi ## Added tier1
LEFT JOIN $pro_pipeline pro using (pro_id)
where pitch_date is not null;

########################################################################
create or replace table $country_bands_table as   
SELECT DISTINCT
COUNTRY_CODE,
METRIC_LIST,
offering_map.KPI, ## This one maps it to the KPI in the offerings table
METRIC
FROM
(SELECT 
country_code,
metric_list,
case metric_list
when 'views_avg_daily_change' then views_avg_daily_change
when 'watch_time_hr_avg_daily_change' then watch_time_hr_avg_daily_change
when 'views_ad_enabled_avg_daily_change' then views_ad_enabled_avg_daily_change
when 'user_subscriptions_added_avg_daily_change' then user_subscriptions_added_avg_daily_change
when 'video_shares_avg_daily_change' then video_shares_avg_daily_change
when 'video_comments_added_avg_daily_change' then video_comments_added_avg_daily_change
when 'video_likes_added_avg_daily_change' then video_likes_added_avg_daily_change
when 'gross_ad_revenue_usd_avg_daily_change' then gross_ad_revenue_usd_avg_daily_change
when 'earnings_usd_avg_daily_change' then earnings_usd_avg_daily_change
when 'ad_impressions_avg_daily_change' then ad_impressions_avg_daily_change
when 'transaction_earnings_usd_avg_daily_change' then transaction_earnings_usd_avg_daily_change
when 'earnings_usd_superchat_avg_daily_change' then earnings_usd_superchat_avg_daily_change
when 'earnings_usd_superstickers_avg_daily_change' then earnings_usd_superstickers_avg_daily_change
when 'earnings_usd_supervod_avg_daily_change' then earnings_usd_supervod_avg_daily_change
when 'earnings_usd_sponsorships_avg_daily_change' then earnings_usd_sponsorships_avg_daily_change
when 'monetized_views_avg_daily_change' then monetized_views_avg_daily_change
when 'daily_videos_added_avg_daily_change' then daily_videos_added_avg_daily_change
when 'google_preferred_ad_impressions_avg_daily_change' then google_preferred_ad_impressions_avg_daily_change
end METRIC
from $country_bands_pipeline, unnest(['views_avg_daily_change', 
'watch_time_hr_avg_daily_change',
'views_ad_enabled_avg_daily_change',
'user_subscriptions_added_avg_daily_change',
'video_shares_avg_daily_change',
'video_comments_added_avg_daily_change',
'video_likes_added_avg_daily_change',
'gross_ad_revenue_usd_avg_daily_change',
'earnings_usd_avg_daily_change',
'ad_impressions_avg_daily_change',
'transaction_earnings_usd_avg_daily_change',
'earnings_usd_superchat_avg_daily_change',
'earnings_usd_superstickers_avg_daily_change',
'earnings_usd_supervod_avg_daily_change',
'earnings_usd_sponsorships_avg_daily_change',
'monetized_views_avg_daily_change',
'daily_videos_added_avg_daily_change',
'google_preferred_ad_impressions_avg_daily_change']) metric_list) base
LEFT JOIN $map_table offering_map on base.metric_list = offering_map.COUNTRY_METRICS_REFERENCE 
WHERE COUNTRY_CODE <>'';

################################################################################################
################################################################################################
################# IMPLEMENTATIONS ################################################################

create or replace table $implementation_table as  ## ADDED tier1 
SELECT
DATE(cast(substr(cast(date_id as string),0,4) as int64),cast(substr(cast (date_id as string),5,2) as int64), cast(substr(cast (date_id as string),7) as int64) )  as date_id_converted,
pro_id,
metric_list,
metric,
CASE WHEN UPPER(metric_list) LIKE '%HAS%' THEN TRUE ELSE FALSE END as BOOLEAN_FIELD,
CASE WHEN UPPER(metric_list) LIKE '%PCT%' THEN 'PERCENT' 
     WHEN UPPER(metric_list) LIKE '%HAS%'THEN 'BOOL'
       ELSE 'NUMBER' END as METRIC_TYPE 
FROM
(select 
date_id,
pro_id,
metric_list,
case metric_list 
## Not Used -- Work in progress
-- when 'ad_disabled_views_30d' then ad_disabled_views_30d
when 'ad_limited_pct_30d' then ad_limited_pct_30d # Added back 4/12
when 'red_pct_30d' then red_pct_30d # Added back 4/12
when 'custom_thumbnails_pct_30d' then custom_thumbnails_pct_30d # Added back 4/12
-- when 'has_banner' then has_banner
-- when 'has_branding_watermark' then has_branding_watermark
-- when 'has_superchat' then has_superchat
-- when 'has_channel_membership' then has_channel_membership
## Not found
-- when 'num_desktop_live_30d' then num_desktop_live_30d ## Currently not on upstream table (broken) 
-- when 'num_console_live_30d' then num_console_live_30d ## Currently not on upstream table (broken) 
-- when 'num_mobile_live_30d' then num_mobile_live_30d ## Currently not on upstream table (broken) 

when 'watch_completion_pct_30d' then watch_completion_pct_30d
when 'mon_pct_30d' then mon_pct_30d
when 'mon_eligible_enabled_pct_30d' then mon_eligible_enabled_pct_30d ## Not currently mapped to offering table
when 'midroll_enabled_pct_30d' then midroll_enabled_pct_30d
when 'num_eligible_longform_30d' then num_eligible_longform_30d
when 'non_skippable_enabled_pct_30d' then non_skippable_enabled_pct_30d
when 'overlay_enabled_pct_30d' then overlay_enabled_pct_30d
when 'skippable_enabled_pct_30d' then skippable_enabled_pct_30d
when 'sponsor_cards_enabled_pct_30d' then sponsor_cards_enabled_pct_30d
when 'cards_pct_30d' then cards_pct_30d
when 'end_screens_pct_30d' then end_screens_pct_30d
when 'in_creator_playlist_pct_30d' then in_creator_playlist_pct_30d
when 'in_series_playlist_pct_30d' then in_series_playlist_pct_30d
when 'num_community_posts_30d' then num_community_posts_30d
when 'num_stories_30d' then num_stories_30d
when 'num_premieres_30d' then num_premieres_30d
when 'num_superchat_30d' then num_superchat_30d
when 'num_member_30d' then num_member_30d
when 'banner_pct' then banner_pct
when 'watermark_pct' then watermark_pct
when 'memberships_enabled_pct' then memberships_enabled_pct
when 'current_num_channels_with_unresolved_tou_strikes' then current_num_channels_with_unresolved_tou_strikes ## Not currently mapped to offering table
when 'current_num_channels_with_unresolved_copyright_strikes' then current_num_channels_with_unresolved_copyright_strikes ## Not currently mapped to offering table
when 'artist_dea_pct' then artist_dea_pct
###################################################### 
when 'superchat_enabled_pct' then superchat_enabled_pct
when 'num_livestreams_30d' then num_livestreams_30d
when 'num_badges' then num_badges
when 'num_emoji' then num_emoji
when 'num_member_only_videos_30d' then num_member_only_videos_30d
when 'num_member_only_chat_30d' then num_member_only_chat_30d  
when 'has_communicate_on_his_offer_pct' then has_communicate_on_his_offer_pct  
when 'multiple_levels_pct' then multiple_levels_pct  
when 'niche_perks_pct' then niche_perks_pct
when 'num_shorts_uploads' then num_shorts_uploads
when 'num_shorts_creation_tools_uploads' then num_shorts_creation_tools_uploads
      
END METRIC
from (select * 
--  case when has_channel_membership IS TRUE then 1 ELSE 0 end as has_channel_membership,
--  case when has_channel_membership IS TRUE then 1 ELSE 0 end as has_superchat,
--  case when has_banner IS TRUE then 1 ELSE 0 end as has_banner,
--  case when has_branding_watermark IS TRUE then 1 ELSE 0 end as has_branding_watermark
 FROM $implementation_pipeline) base ## ADDED tier1 
, unnest(['watch_completion_pct_30d',
-- 'ad_disabled_views_30d',
'ad_limited_pct_30d',
'custom_thumbnails_pct_30d',
-- 'has_banner',
-- 'has_branding_watermark',
-- 'has_superchat',
-- 'has_channel_membership',
-- 'num_desktop_live_30d',
-- 'num_console_live_30d',
-- 'num_mobile_live_30d
'mon_pct_30d',
'mon_eligible_enabled_pct_30d',
'midroll_enabled_pct_30d',
'num_eligible_longform_30d',
'non_skippable_enabled_pct_30d',
'overlay_enabled_pct_30d',  
'skippable_enabled_pct_30d',
'sponsor_cards_enabled_pct_30d',
'cards_pct_30d',
'end_screens_pct_30d',
'in_creator_playlist_pct_30d',
'in_series_playlist_pct_30d',
'num_community_posts_30d',
'num_stories_30d',
'num_premieres_30d',
'banner_pct', ## Replaced has_banner with pct 
'watermark_pct', ## Replaced has_watermark with pct 
'memberships_enabled_pct', ## Replaced has_membership with pct
'num_superchat_30d',
'num_member_30d',  
'current_num_channels_with_unresolved_tou_strikes', ## added 12/7 not in the implementation now but will be implemented later
'current_num_channels_with_unresolved_copyright_strikes', ## added 12/7 not in the implementation now but will be implemented later
'artist_dea_pct',
####################################### Added on 4/12/21 to match https://docs.google.com/spreadsheets/d/1WtsignCMWbwCO5_WPjh5chjNDL7MZyAQ8cPn_fgwLE8/edit#gid=1589081115
'superchat_enabled_pct',
'red_pct_30d',
'num_livestreams_30d',
'num_badges',
'num_emoji',
'num_member_only_videos_30d',
'num_member_only_chat_30d',
'has_communicate_on_his_offer_pct',
'multiple_levels_pct',
'niche_perks_pct',
'num_shorts_uploads',
'num_shorts_creation_tools_uploads'

]) METRIC_LIST 
where pro_id IN (select distinct pro_id from $opportunity_pipeline)
) GROUP BY 1,2,3,4;
RUN google::project_io_permissions();
